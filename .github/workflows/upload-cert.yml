name: Upload Certificate

# Controls when the action will run.
on:
  # Run after the cert has been created
  workflow_run:
    workflows: ["Update Certificate"]
    types: ["completed"]
      
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  upload-cert:
    runs-on: ubuntu-latest
    steps:
      - name: Copy certificate public chain
        uses: DamianReeves/write-file-action@v1.0
        with:
          path: ~/*.homelab.express.cer.txt
          contents: ${{ secrets.CERT_PUBLIC_CHAIN }}
          write-mode: overwrite
      - name: Create certificate private key file
        id: write-file
        uses: timheuer/base64-to-file@v1
        with:
          fileName: '*.homelab.express.pfx.txt'
          encodedString: ${{ secrets.CERT_PRIVATE_KEY }}
      - name: Copy certificate private key
        shell: bash
        run: mv ${{ steps.write-file.outputs.filePath }} ~/
      - name: List files
        shell: bash
        run: ls ~/
      - name: FTP Deploy
        uses: cinderblockgames/ftp-action@v1.2.2
        with:
          # required
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          # optional
          source: ~/
          destination: cert/
          skipUnchanged: true
